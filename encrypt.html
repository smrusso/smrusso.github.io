<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Offline Encryptor</title>
    <style>
        body {
            font-family: sans-serif;
            line-height: 1.4;
        }

        button.copy-btn {
            margin-left: 0.5em;
            font-size: 0.9em;
        }

        pre {
            background: #f4f4f4;
            padding: 0.5em;
            border-radius: 4px;
            overflow-x: auto;
        }
    </style>
</head>
<body>
<h1>Offline Encryptor</h1>
<p>Enter your master secret and the sensitive data below to encrypt it.</p>

<label for="secret">16-byte secret (URL-safe Base64):</label><br>
<input type="text" id="secret" size="50">
<button onclick="generateSecret()">Generate New Secret</button>
<br><br>

<label for="scriptId">Script ID:</label><br>
<input type="text" id="scriptId" size="100"><br><br>

<label for="iban">IBAN:</label><br>
<input type="text" id="iban" size="50"><br><br>

<label for="owner">Account Owner:</label><br>
<input type="text" id="owner" size="50"><br><br>

<button onclick="encryptData()">Encrypt</button>

<hr>

<h2>Outputs:</h2>
<p>Copy these values into your project's files as instructed.</p>

<div id="outputSection" style="display:none;">
    <h3>Encrypted Check</h3>
    <label>Ciphertext:</label>
    <button class="copy-btn" onclick="copyValue(this, 'checkCiphertext')">Copy</button>
    <pre id="checkCiphertext"></pre>

    <label>IV:</label>
    <button class="copy-btn" onclick="copyValue(this, 'checkIV')">Copy</button>
    <pre id="checkIV"></pre>

    <h3>Encrypted IBAN</h3>
    <label>Ciphertext:</label>
    <button class="copy-btn" onclick="copyValue(this, 'ibanCiphertext')">Copy</button>
    <pre id="ibanCiphertext"></pre>

    <label>IV:</label>
    <button class="copy-btn" onclick="copyValue(this, 'ibanIV')">Copy</button>
    <pre id="ibanIV"></pre>

    <h3>Encrypted Script ID</h3>
    <label>Ciphertext:</label>
    <button class="copy-btn" onclick="copyValue(this, 'scriptIdCiphertext')">Copy</button>
    <pre id="scriptIdCiphertext"></pre>

    <label>IV:</label>
    <button class="copy-btn" onclick="copyValue(this, 'scriptIdIV')">Copy</button>
    <pre id="scriptIdIV"></pre>
</div>
<script>
    // ---------- Utility Functions ----------

    // Validate and decode Base64URL
    function base64UrlToBytes(base64Url) {
        // Strict URL-safe Base64 check (no +, /, =)
        if (!/^[A-Za-z0-9\-_]+$/.test(base64Url)) {
            throw new Error('Secret must contain only URL-safe Base64 characters (A–Z, a–z, 0–9, "-", "_").');
        }

        // Convert to standard Base64
        let base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
        while (base64.length % 4) base64 += '=';

        try {
            const binary = atob(base64);
            return Uint8Array.from(binary, c => c.charCodeAt(0));
        } catch {
            throw new Error('Invalid Base64 encoding in secret.');
        }
    }

    // Robust Base64 encoder supporting large buffers
    function toBase64(buffer) {
        const bytes = new Uint8Array(buffer);
        const chunkSize = 0x8000;
        let binary = '';
        for (let i = 0; i < bytes.length; i += chunkSize) {
            binary += String.fromCharCode(...bytes.subarray(i, i + chunkSize));
        }
        return btoa(binary);
    }

    function generateSecret() {
        const randomBytes = crypto.getRandomValues(new Uint8Array(16));
        const base64 = btoa(String.fromCharCode(...randomBytes));
        const base64Url = base64.replace(/\+/g, '-').replace(/\//g, '_').replace(/=/g, '');
        document.getElementById('secret').value = base64Url;
    }

    // ---------- Improved Clipboard Copy ----------

    async function copyValue(btn, elementId) {
        const el = document.getElementById(elementId);
        const text = el.textContent.trim();
        if (!text) return;

        try {
            await navigator.clipboard.writeText(text);
            const oldText = btn.textContent;
            btn.textContent = 'Copied!';
            btn.disabled = true;
            setTimeout(() => {
                btn.textContent = oldText;
                btn.disabled = false;
            }, 1200);
        } catch (err) {
            console.error('Clipboard error:', err);
            alert('Failed to copy to clipboard. Please copy manually.');
        }
    }

    // ---------- Main Encryption Logic ----------

    async function encryptData() {
        const secret = document.getElementById('secret').value.trim();
        const scriptId = document.getElementById('scriptId').value.trim();
        const iban = document.getElementById('iban').value.trim();
        const owner = document.getElementById('owner').value.trim();

        if (!secret || !scriptId || !iban || !owner) {
            alert('Please fill all fields.');
            return;
        }

        try {
            const keyBytes = base64UrlToBytes(secret);
            if (keyBytes.length !== 16) {
                alert(`Secret must decode to exactly 16 bytes (got ${keyBytes.length}).`);
                return;
            }

            const key = await crypto.subtle.importKey(
                'raw',
                keyBytes,
                { name: 'AES-GCM', length: 128 },
                false,
                ['encrypt']
            );

            const encoder = new TextEncoder();

            async function encrypt(plaintext) {
                const iv = crypto.getRandomValues(new Uint8Array(12));
                const encryptedData = await crypto.subtle.encrypt(
                    { name: 'AES-GCM', iv },
                    key,
                    encoder.encode(plaintext)
                );
                return { ciphertext: toBase64(encryptedData), iv: toBase64(iv) };
            }

            // Encrypt JSON object for IBAN + owner
            const ibanPayload = JSON.stringify({ iban, owner });

            const encryptedScriptId = await encrypt(scriptId);
            const encryptedIban = await encrypt(ibanPayload);
            const encryptedCheck = await encrypt('check');

            document.getElementById('checkCiphertext').textContent = encryptedCheck.ciphertext;
            document.getElementById('checkIV').textContent = encryptedCheck.iv;
            document.getElementById('ibanCiphertext').textContent = encryptedIban.ciphertext;
            document.getElementById('ibanIV').textContent = encryptedIban.iv;
            document.getElementById('scriptIdCiphertext').textContent = encryptedScriptId.ciphertext;
            document.getElementById('scriptIdIV').textContent = encryptedScriptId.iv;

            document.getElementById('outputSection').style.display = 'block';

        } catch (e) {
            console.error(e);
            alert('Encryption failed: ' + e.message);
        }
    }
</script>
</body>
</html>
